<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>二択ギャラリー（投票・％・名前・画像任意対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    h1, h2 {
      margin: 0 0 8px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      font-size: 14px;
      margin-top: 8px;
    }
    input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    input[type="file"] {
      margin-top: 4px;
      font-size: 13px;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    button.primary {
      background: #2563eb;
      color: #fff;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button.small {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
    }
    .pair {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px;
      margin-top: 8px;
      background: #fafafa;
    }
    .pair-header {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .flex {
      display: flex;
      gap: 8px;
    }
    .flex > div {
      flex: 1;
    }
    .hidden {
      display: none;
    }
    .snack-image {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      display: block;
      margin: 0 auto;
    }
    .choice-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .choice {
      flex: 1;
      border-radius: 10px;
      border: 2px solid transparent;
      padding: 8px;
      background: #fff;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.1s ease, box-shadow 0.1s ease;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .choice:hover {
      box-shadow: 0 0 0 2px rgba(37,99,235,0.15);
    }
    .choice.selected {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37,99,235,0.2);
    }
    .choice-media {
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .text-only-box {
      border-radius: 8px;
      border: 1px dashed #d1d5db;
      padding: 8px;
      font-size: 16px;
      font-weight: 600;
      word-break: break-word;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .choice-label {
      font-weight: 600;
      margin-top: 4px;
      font-size: 14px;
      word-break: break-word;
    }
    .message {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
      word-break: break-all;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #e5e7eb;
      color: #374151;
      margin-right: 6px;
    }
    .my-gallery-item {
      border-bottom: 1px solid #eee;
      padding: 4px 0 8px;
    }
    .my-gallery-title {
      font-size: 14px;
      font-weight: 600;
    }
    .my-gallery-meta {
      font-size: 11px;
      color: #6b7280;
    }
    .vote-summary {
      font-size: 12px;
      color: #4b5563;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>二択ギャラリー（投票％・名前・画像任意）</h1>

  <!-- 作成済みギャラリー一覧 -->
  <div id="myGalleriesCard" class="card">
    <h2>作成済みギャラリー一覧（この端末）</h2>
    <div id="myGalleriesList" class="message">まだこのブラウザではギャラリーを作成していません。</div>
  </div>

  <!-- ビルダー画面 -->
  <div id="builder" class="card">
    <h2 id="builderHeading">① ギャラリー作成</h2>
    <label>
      ギャラリーのタイトル（例: お菓子二択バトル）
      <input type="text" id="galleryTitle" placeholder="お菓子二択バトル">
    </label>

    <div style="margin-top:12px;">
      <span class="badge">STEP 1</span> ペア（対戦カード）を追加していく（画像なしテキストのみもOK）
    </div>
    <button id="addPairBtn" class="secondary">＋ ペアを追加</button>

    <div id="pairsContainer"></div>

    <div style="margin-top:12px;">
      <span class="badge">STEP 2</span> Supabase に保存して共有リンク作成
    </div>
    <button id="saveGalleryBtn" class="primary">ギャラリー保存＆共有URLを生成</button>
    <div id="builderMessage" class="message"></div>
  </div>

  <!-- ビューア画面 -->
  <div id="viewer" class="card hidden">
    <h2 id="viewerTitle">② ギャラリーを見る・投票する</h2>

    <label>
      お名前（任意・ゆるい連投チェック用）
      <input type="text" id="voterName" placeholder="例：たろう">
    </label>

    <div id="viewerContent"></div>
    <div id="viewerMessage" class="message"></div>
  </div>

  <script>
    // ====== 設定 ==========================================
    const APP_CONFIG = {
      supabase: {
        // ★ここを自分の Supabase プロジェクトに合わせる
        url: "https://cxqxwqgskhezckinggow.supabase.co",
        anonKey: "sb_publishable_KvO6r5kb_ZU2Nq8qTUmMog_VRcK68yp",
        bucketName: "snack-images",
        votesTable: "votes",
      },
      image: {
        maxWidth: 200,
        maxHeight: 200,
        mime: "image/jpeg",
        quality: 0.8,
      },
      history: {
        maxMyGalleries: 50,
      },
    };

    const { createClient } = supabase;
    const SUPABASE_URL = APP_CONFIG.supabase.url;
    const SUPABASE_ANON_KEY = APP_CONFIG.supabase.anonKey;
    const BUCKET_NAME = APP_CONFIG.supabase.bucketName;
    const VOTES_TABLE = APP_CONFIG.supabase.votesTable || "votes";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const MAX_WIDTH = APP_CONFIG.image.maxWidth;
    const MAX_HEIGHT = APP_CONFIG.image.maxHeight;
    const OUTPUT_MIME = APP_CONFIG.image.mime;
    const OUTPUT_QUALITY = APP_CONFIG.image.quality;

    // ゆるい連投対策 & 名前保存用
    const VOTER_NAME_KEY = "snackVoterName";
    const VOTED_GALLERY_PREFIX = "snackVoted_";

    // ====== 画像リサイズ ==================================
    function resizeImage(file, maxWidth, maxHeight, mimeType = OUTPUT_MIME, quality = OUTPUT_QUALITY) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);

        img.onload = () => {
          URL.revokeObjectURL(url);

          let { width, height } = img;
          const scale = Math.min(
            maxWidth / width,
            maxHeight / height,
            1
          );

          const canvas = document.createElement("canvas");
          canvas.width = Math.round(width * scale);
          canvas.height = Math.round(height * scale);

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          canvas.toBlob(
            (blob) => {
              if (!blob) {
                reject(new Error("画像のリサイズに失敗しました"));
                return;
              }
              resolve(blob);
            },
            mimeType,
            quality
          );
        };

        img.onerror = (e) => {
          URL.revokeObjectURL(url);
          reject(e);
        };

        img.src = url;
      });
    }

    function getStoragePathFromPublicUrl(url) {
      try {
        const marker = `/object/public/${BUCKET_NAME}/`;
        const idx = url.indexOf(marker);
        if (idx === -1) return null;
        let rel = url.slice(idx + marker.length);
        rel = rel.split("?")[0].split("#")[0];
        return rel;
      } catch {
        return null;
      }
    }

    // ====== URL パラメータ =================================
    const params = new URLSearchParams(window.location.search);
    const galleryIdFromUrl = params.get("gallery");
    const editGalleryIdFromUrl = params.get("edit");

    const builderEl = document.getElementById("builder");
    const viewerEl = document.getElementById("viewer");
    const pairsContainer = document.getElementById("pairsContainer");
    const builderMessageEl = document.getElementById("builderMessage");
    const viewerMessageEl = document.getElementById("viewerMessage");
    const builderHeadingEl = document.getElementById("builderHeading");
    const myGalleriesListEl = document.getElementById("myGalleriesList");
    const voterNameInput = document.getElementById("voterName");

    let pairCount = 0;
    let currentSelections = {};
    let viewerPairCount = 0;
    let isSubmittingVote = false;

    // ====== localStorage: ギャラリー一覧 ===================
    const MY_GALLERIES_KEY = "mySnackGalleries";
    const MAX_MY_GALLERIES = APP_CONFIG.history.maxMyGalleries;

    function loadMyGalleries() {
      try {
        const raw = localStorage.getItem(MY_GALLERIES_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error("localStorage parse error", e);
        return [];
      }
    }

    function saveMyGalleries(list) {
      try {
        localStorage.setItem(MY_GALLERIES_KEY, JSON.stringify(list));
      } catch (e) {
        console.error("localStorage save error", e);
      }
    }

    function addMyGallery(id, title) {
      const list = loadMyGalleries();
      const now = new Date().toISOString();
      list.unshift({
        id,
        title: title || "(無題)",
        createdAt: now
      });
      saveMyGalleries(list.slice(0, MAX_MY_GALLERIES));
      renderMyGalleriesList();
    }

    function deleteMyGallery(id) {
      const list = loadMyGalleries().filter(g => g.id !== id);
      saveMyGalleries(list);
      renderMyGalleriesList();
    }

    async function hardDeleteGallery(id) {
      try {
        const { data, error } = await sb
          .from("galleries")
          .select("config")
          .eq("id", id)
          .single();

        if (error) {
          console.error(error);
          alert("galleries の取得でエラーが発生しました:\n" + JSON.stringify(error, null, 2));
          return;
        }

        let paths = [];
        if (data && data.config && Array.isArray(data.config.pairs)) {
          data.config.pairs.forEach(pair => {
            if (pair.left) {
              if (pair.left.storagePath) {
                paths.push(pair.left.storagePath);
              } else if (pair.left.imageUrl) {
                const p = getStoragePathFromPublicUrl(pair.left.imageUrl);
                if (p) paths.push(p);
              }
            }
            if (pair.right) {
              if (pair.right.storagePath) {
                paths.push(pair.right.storagePath);
              } else if (pair.right.imageUrl) {
                const p = getStoragePathFromPublicUrl(pair.right.imageUrl);
                if (p) paths.push(p);
              }
            }
          });
        }

        paths = Array.from(new Set(paths));
        console.log("Deleting storage paths:", paths);

        if (paths.length > 0) {
          const { error: storageError } = await sb
            .storage
            .from(BUCKET_NAME)
            .remove(paths);

          if (storageError) {
            console.error(storageError);
            alert("画像の削除でエラーが発生しました:\n" + JSON.stringify(storageError, null, 2));
          }
        }

        const { error: deleteError } = await sb
          .from("galleries")
          .delete()
          .eq("id", id);

        if (deleteError) {
          console.error(deleteError);
          alert("galleries の削除でエラーが発生しました:\n" + JSON.stringify(deleteError, null, 2));
          return;
        }

        deleteMyGallery(id);
        alert("Supabase上のデータと画像を完全に削除しました。");
      } catch (e) {
        console.error(e);
        alert("削除中にエラーが発生しました:\n" + (e.message || e));
      }
    }

    function renderMyGalleriesList() {
      const list = loadMyGalleries();
      if (!list.length) {
        myGalleriesListEl.textContent = "まだこのブラウザではギャラリーを作成していません。";
        return;
      }
      myGalleriesListEl.innerHTML = "";
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "my-gallery-item";

        const title = document.createElement("div");
        title.className = "my-gallery-title";
        title.textContent = item.title;
        div.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "my-gallery-meta";
        const d = new Date(item.createdAt);
        meta.textContent = `ID: ${item.id} / 作成: ${d.toLocaleString()}`;
        div.appendChild(meta);

        const btnRow = document.createElement("div");

        const openBtn = document.createElement("button");
        openBtn.className = "secondary small";
        openBtn.textContent = "開く（投票画面）";
        openBtn.addEventListener("click", () => {
          const url = `${location.origin}${location.pathname}?gallery=${encodeURIComponent(item.id)}`;
          window.open(url, "_blank");
        });
        btnRow.appendChild(openBtn);

        const editBtn = document.createElement("button");
        editBtn.className = "secondary small";
        editBtn.style.marginLeft = "4px";
        editBtn.textContent = "編集する（複製）";
        editBtn.addEventListener("click", () => {
          const url = `${location.pathname}?edit=${encodeURIComponent(item.id)}`;
          location.href = url;
        });
        btnRow.appendChild(editBtn);

        const copyBtn = document.createElement("button");
        copyBtn.className = "secondary small";
        copyBtn.style.marginLeft = "4px";
        copyBtn.textContent = "URLコピー";
        copyBtn.addEventListener("click", () => {
          const url = `${location.origin}${location.pathname}?gallery=${encodeURIComponent(item.id)}`;
          navigator.clipboard?.writeText(url).catch(() => {});
          alert("URLをコピーしました:\n" + url);
        });
        btnRow.appendChild(copyBtn);

        const hardDeleteBtn = document.createElement("button");
        hardDeleteBtn.className = "secondary small";
        hardDeleteBtn.style.marginLeft = "4px";
        hardDeleteBtn.textContent = "完全削除（DB+画像）";
        hardDeleteBtn.addEventListener("click", () => {
          if (confirm("Supabase上のデータと画像も含めて完全に削除しますか？\nこの操作は取り消せません。")) {
            hardDeleteGallery(item.id);
          }
        });
        btnRow.appendChild(hardDeleteBtn);

        div.appendChild(btnRow);
        myGalleriesListEl.appendChild(div);
      });
    }

    renderMyGalleriesList();

    // ====== ペアの番号振り直し =============================
    function renumberPairs() {
      const pairEls = Array.from(document.querySelectorAll(".pair"));
      pairEls.forEach((el, idx) => {
        const header = el.querySelector(".pair-header");
        if (header) header.textContent = `ペア ${idx + 1}`;
      });
    }

    // ====== ビルダー: ペア追加 ==============================
    function addPair(existingPair) {
      pairCount++;
      const pairId = `pair-${pairCount}`;

      const wrapper = document.createElement("div");
      wrapper.className = "pair";
      wrapper.dataset.pairId = pairId;

      if (existingPair) {
        wrapper.dataset.leftUrl = existingPair.left?.imageUrl || "";
        wrapper.dataset.rightUrl = existingPair.right?.imageUrl || "";
        wrapper.dataset.leftPath =
          existingPair.left?.storagePath ||
          (existingPair.left?.imageUrl
            ? getStoragePathFromPublicUrl(existingPair.left.imageUrl)
            : "");
        wrapper.dataset.rightPath =
          existingPair.right?.storagePath ||
          (existingPair.right?.imageUrl
            ? getStoragePathFromPublicUrl(existingPair.right.imageUrl)
            : "");
      }

      wrapper.innerHTML = `
        <div class="pair-header">ペア ${pairCount}</div>
        <label>
          ペアタイトル（例: アルフォート）
          <input type="text" class="pair-title" placeholder="アルフォート">
        </label>
        <div class="flex">
          <div>
            <label>
              左ラベル（例: ミルクチョコ）
              <input type="text" class="left-label" placeholder="ミルクチョコ">
            </label>
            <label>
              左画像ファイル（任意）
              <input type="file" class="left-file" accept="image/*">
            </label>
            <div class="left-preview"></div>
          </div>
          <div>
            <label>
              右ラベル（例: リッチミルク）
              <input type="text" class="right-label" placeholder="リッチミルク">
            </label>
            <label>
              右画像ファイル（任意）
              <input type="file" class="right-file" accept="image/*">
            </label>
            <div class="right-preview"></div>
          </div>
        </div>
      `;

      if (existingPair) {
        wrapper.querySelector(".pair-title").value = existingPair.title || "";
        wrapper.querySelector(".left-label").value = existingPair.left?.label || "";
        wrapper.querySelector(".right-label").value = existingPair.right?.label || "";

        const leftPrev = wrapper.querySelector(".left-preview");
        const rightPrev = wrapper.querySelector(".right-preview");

        if (existingPair.left?.imageUrl) {
          const img = document.createElement("img");
          img.src = existingPair.left.imageUrl;
          img.alt = existingPair.left.label || "";
          img.className = "snack-image";
          leftPrev.appendChild(img);
        }
        if (existingPair.right?.imageUrl) {
          const img = document.createElement("img");
          img.src = existingPair.right.imageUrl;
          img.alt = existingPair.right.label || "";
          img.className = "snack-image";
          rightPrev.appendChild(img);
        }
      }

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "secondary small";
      deleteBtn.style.marginTop = "8px";
      deleteBtn.textContent = "このペアを削除";
      deleteBtn.addEventListener("click", () => {
        if (confirm("このペアを削除しますか？")) {
          wrapper.remove();
          renumberPairs();
        }
      });
      wrapper.appendChild(deleteBtn);

      pairsContainer.appendChild(wrapper);
      renumberPairs();
    }

    document.getElementById("addPairBtn").addEventListener("click", () => {
      addPair();
    });

    // ====== 画像アップロード ================================
    async function uploadImage(file, galleryId, pairIndex, side) {
      const resizedBlob = await resizeImage(
        file,
        MAX_WIDTH,
        MAX_HEIGHT,
        OUTPUT_MIME,
        OUTPUT_QUALITY
      );
      const ext = "jpg";
      const path = `${galleryId}/${pairIndex}-${side}-${Date.now()}.${ext}`;

      const { error } = await sb.storage
        .from(BUCKET_NAME)
        .upload(path, resizedBlob, {
          contentType: OUTPUT_MIME
        });

      if (error) {
        console.error("upload error", error);
        throw error;
      }

      const { data: publicData } = sb.storage
        .from(BUCKET_NAME)
        .getPublicUrl(path);

      return {
        path,
        url: publicData.publicUrl
      };
    }

    // ====== ギャラリー保存 =================================
    document.getElementById("saveGalleryBtn").addEventListener("click", async () => {
      builderMessageEl.textContent = "";

      const galleryTitle = document.getElementById("galleryTitle").value.trim();
      if (!galleryTitle) {
        builderMessageEl.textContent = "ギャラリータイトルを入力してください。";
        return;
      }

      const pairEls = Array.from(document.querySelectorAll(".pair"));
      if (pairEls.length === 0) {
        builderMessageEl.textContent = "少なくとも1つはペアを追加してください。";
        return;
      }

      const galleryId = crypto.randomUUID();
      const pairs = [];

      try {
        for (let i = 0; i < pairEls.length; i++) {
          const pairEl = pairEls[i];
          const pairTitle = pairEl.querySelector(".pair-title").value.trim();
          const leftLabel = pairEl.querySelector(".left-label").value.trim();
          const rightLabel = pairEl.querySelector(".right-label").value.trim();
          const leftFileInput = pairEl.querySelector(".left-file");
          const rightFileInput = pairEl.querySelector(".right-file");

          const leftFile = leftFileInput.files[0];
          const rightFile = rightFileInput.files[0];

          const existingLeftUrl = pairEl.dataset.leftUrl || "";
          const existingRightUrl = pairEl.dataset.rightUrl || "";
          const existingLeftPath = pairEl.dataset.leftPath || "";
          const existingRightPath = pairEl.dataset.rightPath || "";

          if (!pairTitle || !leftLabel || !rightLabel) {
            throw new Error(`ペア ${i + 1} の入力が不足しています。タイトル・左右ラベルをすべて指定してください。`);
          }

          let leftImageUrl = existingLeftUrl;
          let rightImageUrl = existingRightUrl;
          let leftStoragePath = existingLeftPath;
          let rightStoragePath = existingRightPath;

          if (leftFile) {
            const leftUploaded = await uploadImage(leftFile, galleryId, i + 1, "left");
            leftImageUrl = leftUploaded.url;
            leftStoragePath = leftUploaded.path;
          }
          if (rightFile) {
            const rightUploaded = await uploadImage(rightFile, galleryId, i + 1, "right");
            rightImageUrl = rightUploaded.url;
            rightStoragePath = rightUploaded.path;
          }

          // ※ 画像は任意なのでチェックしない（両方テキストのみもOK）

          pairs.push({
            title: pairTitle,
            left: {
              label: leftLabel,
              imageUrl: leftImageUrl || null,
              storagePath: leftStoragePath || null
            },
            right: {
              label: rightLabel,
              imageUrl: rightImageUrl || null,
              storagePath: rightStoragePath || null
            }
          });
        }

        const config = {
          title: galleryTitle,
          pairs
        };

        const { error } = await sb
          .from("galleries")
          .insert({
            id: galleryId,
            title: galleryTitle,
            config
          });

        if (error) {
          console.error(error);
          alert("Supabase error:\n" + JSON.stringify(error, null, 2));
          throw error;
        }

        const shareUrl = `${location.origin}${location.pathname}?gallery=${encodeURIComponent(galleryId)}`;

        addMyGallery(galleryId, galleryTitle);

        builderMessageEl.innerHTML = `保存しました！<br>このURLを友だちに送ってください：<br><a href="${shareUrl}" target="_blank">${shareUrl}</a>`;
      } catch (err) {
        console.error(err);
        builderMessageEl.textContent = `エラーが発生しました: ${err.message || err}`;
      }
    });

    // ====== 投票集計（％込み） =============================
    async function loadVoteSummary(galleryId, pairCount) {
      const summaries = {};
      for (let i = 1; i <= pairCount; i++) {
        summaries[i] = { left: 0, right: 0 };
      }

      const { data, error } = await sb
        .from(VOTES_TABLE)
        .select("pair_index, choice")
        .eq("gallery_id", galleryId);

      if (error) {
        console.error(error);
        viewerMessageEl.textContent = "投票結果の取得に失敗しました。";
        return;
      }

      (data || []).forEach(row => {
        const idx = row.pair_index;
        if (!summaries[idx]) summaries[idx] = { left: 0, right: 0 };
        if (row.choice === "left") summaries[idx].left++;
        if (row.choice === "right") summaries[idx].right++;
      });

      for (let i = 1; i <= pairCount; i++) {
        const summaryEl = document.querySelector(`.vote-summary[data-pair-index="${i}"]`);
        if (!summaryEl) continue;
        const s = summaries[i];
        const total = s.left + s.right;
        if (total === 0) {
          summaryEl.textContent = "まだ投票はありません。";
        } else {
          const leftPct = Math.round((s.left / total) * 100);
          const rightPct = Math.round((s.right / total) * 100);
          summaryEl.textContent =
            `左: ${s.left}票 (${leftPct}%) / 右: ${s.right}票 (${rightPct}%)（合計 ${total}票）`;
        }
      }
    }

    // ====== 投票結果リセット ===============================
    async function resetVotesForGallery() {
      if (!galleryIdFromUrl) return;
      if (!confirm("このギャラリーの全ての投票結果をリセットしますか？\n（全ペアの票数が0になります）")) return;

      viewerMessageEl.textContent = "投票結果をリセットしています…";

      try {
        const { error } = await sb
          .from(VOTES_TABLE)
          .delete()
          .eq("gallery_id", galleryIdFromUrl);

        if (error) {
          console.error(error);
          alert("投票結果リセット時にエラーが発生しました:\n" + JSON.stringify(error, null, 2));
          viewerMessageEl.textContent = "投票結果のリセットに失敗しました。";
          return;
        }

        for (let i = 1; i <= viewerPairCount; i++) {
          const summaryEl = document.querySelector(`.vote-summary[data-pair-index="${i}"]`);
          if (summaryEl) {
            summaryEl.textContent =
              "投票はリセットされました。再度投票するか「投票せずに結果を見る」で表示できます。";
          }
        }

        // ゆるい連投フラグも消しておく
        localStorage.removeItem(VOTED_GALLERY_PREFIX + galleryIdFromUrl);

        viewerMessageEl.textContent = "投票結果をリセットしました。";
      } catch (e) {
        console.error(e);
        alert("投票結果リセット中にエラーが発生しました:\n" + (e.message || e));
        viewerMessageEl.textContent = "投票結果のリセット中にエラーが発生しました。";
      }
    }

    // ====== 投票送信 ======================================
    async function submitVotes() {
      if (!galleryIdFromUrl) return;

      const keys = Object.keys(currentSelections);
      if (keys.length === 0) {
        alert("少なくとも1つのペアで左右どちらかを選んでください。");
        return;
      }
      if (isSubmittingVote) return;

      // ゆるい連投チェック
      const votedKey = VOTED_GALLERY_PREFIX + galleryIdFromUrl;
      if (localStorage.getItem(votedKey)) {
        const cont = confirm("このギャラリーにはすでに投票済みの可能性があります。\nもう一度投票しますか？");
        if (!cont) {
          viewerMessageEl.textContent = "投票をキャンセルしました。";
          return;
        }
      }

      isSubmittingVote = true;
      viewerMessageEl.textContent = "投票送信中…";

      try {
        const name = voterNameInput?.value.trim() || null;
        if (name !== null) {
          localStorage.setItem(VOTER_NAME_KEY, name);
        }

        const rows = keys.map(k => ({
          gallery_id: galleryIdFromUrl,
          pair_index: Number(k),
          choice: currentSelections[k],
          voter_name: name
        }));

        const { error } = await sb
          .from(VOTES_TABLE)
          .insert(rows);

        if (error) {
          console.error(error);
          alert("投票の保存でエラーが発生しました:\n" + JSON.stringify(error, null, 2));
          viewerMessageEl.textContent = "投票の保存でエラーが発生しました。";
        } else {
          // 連投フラグ ON
          localStorage.setItem(votedKey, "1");
          viewerMessageEl.textContent = "投票ありがとうございます！結果を読み込み中…";
          await loadVoteSummary(galleryIdFromUrl, viewerPairCount);
          viewerMessageEl.textContent = "集計結果を表示しました。";
        }
      } catch (e) {
        console.error(e);
        alert("投票中にエラーが発生しました:\n" + (e.message || e));
        viewerMessageEl.textContent = "投票中にエラーが発生しました。";
      } finally {
        isSubmittingVote = false;
      }
    }

    // ====== 投票せずに結果だけ見る ========================
    async function showResultsWithoutVoting() {
      if (!galleryIdFromUrl) return;

      viewerMessageEl.textContent = "現在の集計を読み込み中…";

      try {
        await loadVoteSummary(galleryIdFromUrl, viewerPairCount);
        viewerMessageEl.textContent = "現在の集計結果を表示しました。";
      } catch (e) {
        console.error(e);
        viewerMessageEl.textContent = "集計結果の取得に失敗しました。";
        alert("集計結果取得中にエラーが発生しました:\n" + (e.message || e));
      }
    }

    // ====== viewer: ギャラリー読み込み =====================
    async function loadGalleryForView(galleryId) {
      viewerMessageEl.textContent = "読み込み中…";

      const { data, error } = await sb
        .from("galleries")
        .select("title, config")
        .eq("id", galleryId)
        .single();

      if (error || !data) {
        console.error(error);
        viewerMessageEl.textContent = "ギャラリーが見つかりませんでした。IDやURLを確認してください。";
        return;
      }

      const config = data.config;
      document.getElementById("viewerTitle").textContent =
        config.title || data.title || "ギャラリー";

      const container = document.getElementById("viewerContent");
      container.innerHTML = "";

      currentSelections = {};
      viewerPairCount = (config.pairs || []).length;

      (config.pairs || []).forEach((pair, index) => {
        const pairIndex = index + 1;

        const pairBox = document.createElement("div");
        pairBox.className = "pair";

        const header = document.createElement("div");
        header.className = "pair-header";
        header.textContent = `ペア ${pairIndex}: ${pair.title}`;
        pairBox.appendChild(header);

        const choiceRow = document.createElement("div");
        choiceRow.className = "choice-row";

        // 左
        const leftChoice = document.createElement("div");
        leftChoice.className = "choice";
        leftChoice.dataset.side = "left";

        const leftMedia = document.createElement("div");
        leftMedia.className = "choice-media";

        if (pair.left.imageUrl) {
          const leftImg = document.createElement("img");
          leftImg.src = pair.left.imageUrl;
          leftImg.className = "snack-image";
          leftImg.alt = pair.left.label || "";
          leftMedia.appendChild(leftImg);
          leftChoice.appendChild(leftMedia);

          const leftLabel = document.createElement("div");
          leftLabel.className = "choice-label";
          leftLabel.textContent = pair.left.label;
          leftChoice.appendChild(leftLabel);
        } else {
          const textBox = document.createElement("div");
          textBox.className = "text-only-box";
          textBox.textContent = pair.left.label || "(左)";
          leftMedia.appendChild(textBox);
          leftChoice.appendChild(leftMedia);
        }

        // 右
        const rightChoice = document.createElement("div");
        rightChoice.className = "choice";
        rightChoice.dataset.side = "right";

        const rightMedia = document.createElement("div");
        rightMedia.className = "choice-media";

        if (pair.right.imageUrl) {
          const rightImg = document.createElement("img");
          rightImg.src = pair.right.imageUrl;
          rightImg.className = "snack-image";
          rightImg.alt = pair.right.label || "";
          rightMedia.appendChild(rightImg);
          rightChoice.appendChild(rightMedia);

          const rightLabel = document.createElement("div");
          rightLabel.className = "choice-label";
          rightLabel.textContent = pair.right.label;
          rightChoice.appendChild(rightLabel);
        } else {
          const textBox = document.createElement("div");
          textBox.className = "text-only-box";
          textBox.textContent = pair.right.label || "(右)";
          rightMedia.appendChild(textBox);
          rightChoice.appendChild(rightMedia);
        }

        const onSelect = (selectedEl, otherEl, side) => {
          selectedEl.classList.add("selected");
          otherEl.classList.remove("selected");
          currentSelections[pairIndex] = side;
        };

        leftChoice.addEventListener("click", () => onSelect(leftChoice, rightChoice, "left"));
        rightChoice.addEventListener("click", () => onSelect(rightChoice, leftChoice, "right"));

        choiceRow.appendChild(leftChoice);
        choiceRow.appendChild(rightChoice);

        pairBox.appendChild(choiceRow);

        const summary = document.createElement("div");
        summary.className = "vote-summary";
        summary.dataset.pairIndex = String(pairIndex);
        summary.textContent =
          "※ 投票を送信するか「投票せずに結果を見る」を押すと結果が表示されます。";
        pairBox.appendChild(summary);

        container.appendChild(pairBox);
      });

      if (viewerPairCount > 0) {
        const controlRow = document.createElement("div");
        controlRow.style.marginTop = "12px";

        const submitBtn = document.createElement("button");
        submitBtn.className = "primary";
        submitBtn.textContent = "この投票を送信する";
        submitBtn.addEventListener("click", submitVotes);
        controlRow.appendChild(submitBtn);

        const resetBtn = document.createElement("button");
        resetBtn.className = "secondary";
        resetBtn.style.marginLeft = "8px";
        resetBtn.textContent = "投票結果をリセット";
        resetBtn.addEventListener("click", resetVotesForGallery);
        controlRow.appendChild(resetBtn);

        const showResultsBtn = document.createElement("button");
        showResultsBtn.className = "secondary";
        showResultsBtn.style.marginLeft = "8px";
        showResultsBtn.textContent = "投票せずに結果を見る";
        showResultsBtn.addEventListener("click", showResultsWithoutVoting);
        controlRow.appendChild(showResultsBtn);

        container.appendChild(controlRow);
      }

      viewerMessageEl.textContent =
        "左右を選んでから「この投票を送信する」を押すか、「投票せずに結果を見る」で集計を表示できます。";
    }

    // ====== ビルダー: 編集用ロード ========================
    async function loadGalleryForEdit(galleryId) {
      builderMessageEl.textContent = "編集元ギャラリーを読み込み中…";

      const { data, error } = await sb
        .from("galleries")
        .select("title, config")
        .eq("id", galleryId)
        .single();

      if (error || !data) {
        console.error(error);
        builderMessageEl.textContent = "編集元のギャラリーが見つかりませんでした。IDやURLを確認してください。";
        return;
      }

      const config = data.config;
      document.getElementById("galleryTitle").value = config.title || data.title || "";

      pairsContainer.innerHTML = "";
      pairCount = 0;

      (config.pairs || []).forEach(pair => {
        addPair(pair);
      });

      builderMessageEl.textContent = "編集元を読み込みました。この内容をベースに新しいギャラリーとして保存できます。";
    }

    // ====== 名前の自動入力 =================================
    function prefillVoterName() {
      if (!voterNameInput) return;
      const saved = localStorage.getItem(VOTER_NAME_KEY);
      if (saved !== null) {
        voterNameInput.value = saved;
      }
    }

    // ====== 初期化 =========================================
    (function init() {
      if (editGalleryIdFromUrl) {
        builderHeadingEl.textContent = "① ギャラリー編集（複製して新URLを作成）";
        builderEl.classList.remove("hidden");
        viewerEl.classList.add("hidden");
        loadGalleryForEdit(editGalleryIdFromUrl);
      } else if (galleryIdFromUrl) {
        builderEl.classList.add("hidden");
        viewerEl.classList.remove("hidden");
        prefillVoterName();
        loadGalleryForView(galleryIdFromUrl);
      } else {
        builderHeadingEl.textContent = "① ギャラリー作成（新規）";
        builderEl.classList.remove("hidden");
        viewerEl.classList.add("hidden");
      }
    })();
  </script>
</body>
</html>
