<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>お菓子二択ギャラリー（Supabase版＋一覧＆編集）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase JS（CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    h1, h2 {
      margin: 0 0 8px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      font-size: 14px;
      margin-top: 8px;
    }
    input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    input[type="file"] {
      margin-top: 4px;
      font-size: 13px;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    button.primary {
      background: #2563eb;
      color: #fff;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button.small {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
    }
    .pair {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px;
      margin-top: 8px;
      background: #fafafa;
    }
    .pair-header {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .flex {
      display: flex;
      gap: 8px;
    }
    .flex > div {
      flex: 1;
    }
    .hidden {
      display: none;
    }
    .snack-image {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .choice-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .choice {
      flex: 1;
      border-radius: 10px;
      border: 2px solid transparent;
      padding: 8px;
      background: #fff;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.1s ease, box-shadow 0.1s ease;
    }
    .choice:hover {
      box-shadow: 0 0 0 2px rgba(37,99,235,0.15);
    }
    .choice.selected {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37,99,235,0.2);
    }
    .choice-label {
      font-weight: 600;
      margin-top: 4px;
    }
    .message {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
      word-break: break-all;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #e5e7eb;
      color: #374151;
      margin-right: 6px;
    }
    .my-gallery-item {
      border-bottom: 1px solid #eee;
      padding: 4px 0 8px;
    }
    .my-gallery-title {
      font-size: 14px;
      font-weight: 600;
    }
    .my-gallery-meta {
      font-size: 11px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <h1>お菓子二択ギャラリー（Supabase版）</h1>

  <!-- 作成済みギャラリー一覧（このブラウザで作った履歴） -->
  <div id="myGalleriesCard" class="card">
    <h2>作成済みギャラリー一覧（この端末）</h2>
    <div id="myGalleriesList" class="message">まだこのブラウザではギャラリーを作成していません。</div>
  </div>

  <!-- ビルダー画面（?edit= がないときは新規、あるときは編集モード） -->
  <div id="builder" class="card">
    <h2 id="builderHeading">① ギャラリー作成</h2>
    <label>
      ギャラリーのタイトル（例: お菓子二択バトル）
      <input type="text" id="galleryTitle" placeholder="お菓子二択バトル">
    </label>

    <div style="margin-top:12px;">
      <span class="badge">STEP 1</span> ペア（対戦カード）を追加していく
    </div>
    <button id="addPairBtn" class="secondary">＋ ペアを追加</button>

    <div id="pairsContainer"></div>

    <div style="margin-top:12px;">
      <span class="badge">STEP 2</span> Supabase に保存して共有リンク作成
    </div>
    <button id="saveGalleryBtn" class="primary">ギャラリー保存＆共有URLを生成</button>
    <div id="builderMessage" class="message"></div>
  </div>

  <!-- ビューア画面（?gallery=xxx で開いたとき） -->
  <div id="viewer" class="card hidden">
    <h2 id="viewerTitle">② ギャラリーを見る</h2>
    <div id="viewerContent"></div>
    <div id="viewerMessage" class="message"></div>
  </div>

  <script>
    // ====== Supabase 設定 ============================================
    const { createClient } = supabase;

    // TODO: ここを自分のプロジェクトの値に差し替え
    const SUPABASE_URL = "https://cxqxwqgskhezckinggow.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_KvO6r5kb_ZU2Nq8qTUmMog_VRcK68yp";
    const BUCKET_NAME = "snack-images";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== 画像リサイズ設定 ========================================
    const MAX_WIDTH = 200;
    const MAX_HEIGHT = 200;
    const OUTPUT_MIME = "image/jpeg";
    const OUTPUT_QUALITY = 0.8;

    function resizeImage(file, maxWidth, maxHeight, mimeType = OUTPUT_MIME, quality = OUTPUT_QUALITY) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);

        img.onload = () => {
          URL.revokeObjectURL(url);

          let { width, height } = img;
          const scale = Math.min(
            maxWidth / width,
            maxHeight / height,
            1
          );

          const canvas = document.createElement("canvas");
          canvas.width = Math.round(width * scale);
          canvas.height = Math.round(height * scale);

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          canvas.toBlob(
            (blob) => {
              if (!blob) {
                reject(new Error("画像のリサイズに失敗しました"));
                return;
              }
              resolve(blob);
            },
            mimeType,
            quality
          );
        };

        img.onerror = (e) => {
          URL.revokeObjectURL(url);
          reject(e);
        };

        img.src = url;
      });
    }

    // ====== URL クエリ ===============================================
    const params = new URLSearchParams(window.location.search);
    const galleryIdFromUrl = params.get("gallery"); // viewer 用
    const editGalleryIdFromUrl = params.get("edit"); // 編集モード用

    const builderEl = document.getElementById("builder");
    const viewerEl = document.getElementById("viewer");
    const pairsContainer = document.getElementById("pairsContainer");
    const builderMessageEl = document.getElementById("builderMessage");
    const viewerMessageEl = document.getElementById("viewerMessage");
    const builderHeadingEl = document.getElementById("builderHeading");

    const myGalleriesListEl = document.getElementById("myGalleriesList");

    let pairCount = 0;

    // 編集モードかどうか（元IDは取得にだけ使う。保存時は新IDでINSERT）
    const isEditMode = !!editGalleryIdFromUrl;

    // ====== localStorage: このブラウザで作ったギャラリー一覧 =========
    const MY_GALLERIES_KEY = "mySnackGalleries";

    function loadMyGalleries() {
      try {
        const raw = localStorage.getItem(MY_GALLERIES_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error("localStorage parse error", e);
        return [];
      }
    }

    function saveMyGalleries(list) {
      try {
        localStorage.setItem(MY_GALLERIES_KEY, JSON.stringify(list));
      } catch (e) {
        console.error("localStorage save error", e);
      }
    }

    function addMyGallery(id, title) {
      const list = loadMyGalleries();
      const now = new Date().toISOString();
      list.unshift({
        id,
        title: title || "(無題)",
        createdAt: now
      });
      // とりあえず最新50件くらいに制限
      saveMyGalleries(list.slice(0, 50));
      renderMyGalleriesList();
    }

    function deleteMyGallery(id) {
      const list = loadMyGalleries().filter(g => g.id !== id);
      saveMyGalleries(list);
      renderMyGalleriesList();
    }


    function renderMyGalleriesList() {
      const list = loadMyGalleries();
      if (!list.length) {
        myGalleriesListEl.textContent = "まだこのブラウザではギャラリーを作成していません。";
        return;
      }
      myGalleriesListEl.innerHTML = "";
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "my-gallery-item";

        const title = document.createElement("div");
        title.className = "my-gallery-title";
        title.textContent = item.title;
        div.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "my-gallery-meta";
        const d = new Date(item.createdAt);
        meta.textContent = `ID: ${item.id} / 作成: ${d.toLocaleString()}`;
        div.appendChild(meta);

        const btnRow = document.createElement("div");
        const openBtn = document.createElement("button");
        openBtn.className = "secondary small";
        openBtn.textContent = "開く（投票画面）";
        openBtn.addEventListener("click", () => {
          const url = `${location.origin}${location.pathname}?gallery=${encodeURIComponent(item.id)}`;
          window.open(url, "_blank");
        });
        btnRow.appendChild(openBtn);

        const editBtn = document.createElement("button");
        editBtn.className = "secondary small";
        editBtn.style.marginLeft = "4px";
        editBtn.textContent = "編集する（複製）";
        editBtn.addEventListener("click", () => {
          const url = `${location.pathname}?edit=${encodeURIComponent(item.id)}`;
          location.href = url;
        });
        btnRow.appendChild(editBtn);

        const copyBtn = document.createElement("button");
        copyBtn.className = "secondary small";
        copyBtn.style.marginLeft = "4px";
        copyBtn.textContent = "URLコピー";
        copyBtn.addEventListener("click", () => {
          const url = `${location.origin}${location.pathname}?gallery=${encodeURIComponent(item.id)}`;
          navigator.clipboard?.writeText(url).catch(() => {});
          alert("URLをコピーしました:\n" + url);
        });
        btnRow.appendChild(copyBtn);
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "secondary small";
        deleteBtn.style.marginLeft = "4px";
        deleteBtn.textContent = "一覧から削除";
        deleteBtn.addEventListener("click", () => {
          if (confirm("このギャラリーを一覧から削除しますか？\n（Supabase上のデータは消えません）")) {
            deleteMyGallery(item.id);
          }
        });
        btnRow.appendChild(deleteBtn);

        div.appendChild(btnRow);

        myGalleriesListEl.appendChild(div);
      });
    }

    // 初回描画
    renderMyGalleriesList();

    // ====== ビルダー: ペア追加 =======================================
    function addPair(existingPair) {
      pairCount++;
      const pairId = `pair-${pairCount}`;

      const wrapper = document.createElement("div");
      wrapper.className = "pair";
      wrapper.dataset.pairId = pairId;

      // 既存URLがある場合は dataset に保持
      if (existingPair) {
        wrapper.dataset.leftUrl = existingPair.left?.imageUrl || "";
        wrapper.dataset.rightUrl = existingPair.right?.imageUrl || "";
      }

      wrapper.innerHTML = `
        <div class="pair-header">ペア ${pairCount}</div>
        <label>
          ペアタイトル（例: アルフォート）
          <input type="text" class="pair-title" placeholder="アルフォート">
        </label>
        <div class="flex">
          <div>
            <label>
              左ラベル（例: ミルクチョコ）
              <input type="text" class="left-label" placeholder="ミルクチョコ">
            </label>
            <label>
              左画像ファイル
              <input type="file" class="left-file" accept="image/*">
            </label>
            <div class="left-preview"></div>
          </div>
          <div>
            <label>
              右ラベル（例: リッチミルク）
              <input type="text" class="right-label" placeholder="リッチミルク">
            </label>
            <label>
              右画像ファイル
              <input type="file" class="right-file" accept="image/*">
            </label>
            <div class="right-preview"></div>
          </div>
        </div>
      `;

      // 既存ペアがあるときは値を詰める＋プレビュー表示
      if (existingPair) {
        wrapper.querySelector(".pair-title").value = existingPair.title || "";
        wrapper.querySelector(".left-label").value = existingPair.left?.label || "";
        wrapper.querySelector(".right-label").value = existingPair.right?.label || "";

        const leftPrev = wrapper.querySelector(".left-preview");
        const rightPrev = wrapper.querySelector(".right-preview");

        if (existingPair.left?.imageUrl) {
          const img = document.createElement("img");
          img.src = existingPair.left.imageUrl;
          img.alt = existingPair.left.label || "";
          img.className = "snack-image";
          leftPrev.appendChild(img);
        }
        if (existingPair.right?.imageUrl) {
          const img = document.createElement("img");
          img.src = existingPair.right.imageUrl;
          img.alt = existingPair.right.label || "";
          img.className = "snack-image";
          rightPrev.appendChild(img);
        }
      }

      pairsContainer.appendChild(wrapper);
    }

    document.getElementById("addPairBtn").addEventListener("click", () => {
      addPair();
    });

    // ====== Supabase: 画像アップロード（リサイズ付き） ==================
    async function uploadImage(file, galleryId, pairIndex, side) {
      const resizedBlob = await resizeImage(file, MAX_WIDTH, MAX_HEIGHT);
      const ext = "jpg";
      const path = `${galleryId}/${pairIndex}-${side}-${Date.now()}.${ext}`;

      const { data, error } = await sb.storage
        .from(BUCKET_NAME)
        .upload(path, resizedBlob, {
          contentType: OUTPUT_MIME
        });

      if (error) {
        console.error("upload error", error);
        throw error;
      }

      const { data: publicData } = sb.storage.from(BUCKET_NAME).getPublicUrl(path);
      return {
        path,
        url: publicData.publicUrl
      };
    }

    // ====== ビルダー: ギャラリー保存 ================================
    document.getElementById("saveGalleryBtn").addEventListener("click", async () => {
      builderMessageEl.textContent = "";

      const galleryTitle = document.getElementById("galleryTitle").value.trim();
      if (!galleryTitle) {
        builderMessageEl.textContent = "ギャラリータイトルを入力してください。";
        return;
      }

      const pairEls = Array.from(document.querySelectorAll(".pair"));
      if (pairEls.length === 0) {
        builderMessageEl.textContent = "少なくとも1つはペアを追加してください。";
        return;
      }

      // 編集モードであっても、保存は新しいIDとしてINSERT（元は残す）
      const galleryId = crypto.randomUUID();

      const pairs = [];

      try {
        for (let i = 0; i < pairEls.length; i++) {
          const pairEl = pairEls[i];
          const pairTitle = pairEl.querySelector(".pair-title").value.trim();
          const leftLabel = pairEl.querySelector(".left-label").value.trim();
          const rightLabel = pairEl.querySelector(".right-label").value.trim();
          const leftFileInput = pairEl.querySelector(".left-file");
          const rightFileInput = pairEl.querySelector(".right-file");

          const leftFile = leftFileInput.files[0];
          const rightFile = rightFileInput.files[0];

          // 既存URL（編集モードで読み込んだときにセットされる）
          const existingLeftUrl = pairEl.dataset.leftUrl || "";
          const existingRightUrl = pairEl.dataset.rightUrl || "";

          if (!pairTitle || !leftLabel || !rightLabel) {
            throw new Error(`ペア ${i + 1} の入力が不足しています。タイトル・ラベルをすべて指定してください。`);
          }

          let leftImageUrl = existingLeftUrl;
          let rightImageUrl = existingRightUrl;

          // 新しいファイルが選ばれていたら、それを優先してアップロード
          if (leftFile) {
            const leftUploaded = await uploadImage(leftFile, galleryId, i + 1, "left");
            leftImageUrl = leftUploaded.url;
          }
          if (rightFile) {
            const rightUploaded = await uploadImage(rightFile, galleryId, i + 1, "right");
            rightImageUrl = rightUploaded.url;
          }

          // 新規作成モードでは必ずファイル必須。編集モードからの複製なら既存URLだけでもOK
          if (!leftImageUrl || !rightImageUrl) {
            throw new Error(`ペア ${i + 1} の画像が不足しています。新規作成なら左右両方の画像を指定してください。`);
          }

          pairs.push({
            title: pairTitle,
            left: {
              label: leftLabel,
              imageUrl: leftImageUrl
            },
            right: {
              label: rightLabel,
              imageUrl: rightImageUrl
            }
          });
        }

        const config = {
          title: galleryTitle,
          pairs
        };

        const { error } = await sb
          .from("galleries")
          .insert({
            id: galleryId,
            title: galleryTitle,
            config
          });

        if (error) {
          console.error(error);
          alert("Supabase error:\n" + JSON.stringify(error, null, 2));
          throw error;
        }

        const shareUrl = `${location.origin}${location.pathname}?gallery=${encodeURIComponent(galleryId)}`;

        // このブラウザの履歴に追加
        addMyGallery(galleryId, galleryTitle);

        builderMessageEl.innerHTML = `保存しました！<br>このURLを友だちに送ってください：<br><a href="${shareUrl}" target="_blank">${shareUrl}</a>`;
      } catch (err) {
        console.error(err);
        builderMessageEl.textContent = `エラーが発生しました: ${err.message || err}`;
      }
    });

    // ====== ビューア: ギャラリー読み込み ============================
    async function loadGalleryForView(galleryId) {
      viewerMessageEl.textContent = "読み込み中…";

      const { data, error } = await sb
        .from("galleries")
        .select("title, config")
        .eq("id", galleryId)
        .single();

      if (error || !data) {
        console.error(error);
        viewerMessageEl.textContent = "ギャラリーが見つかりませんでした。IDやURLを確認してください。";
        return;
      }

      const config = data.config;
      document.getElementById("viewerTitle").textContent = config.title || data.title || "ギャラリー";

      const container = document.getElementById("viewerContent");
      container.innerHTML = "";

      config.pairs.forEach((pair, index) => {
        const pairBox = document.createElement("div");
        pairBox.className = "pair";

        const header = document.createElement("div");
        header.className = "pair-header";
        header.textContent = `ペア ${index + 1}: ${pair.title}`;
        pairBox.appendChild(header);

        const choiceRow = document.createElement("div");
        choiceRow.className = "choice-row";

        const leftChoice = document.createElement("div");
        leftChoice.className = "choice";
        leftChoice.dataset.side = "left";

        const leftImg = document.createElement("img");
        leftImg.src = pair.left.imageUrl;
        leftImg.className = "snack-image";
        leftImg.alt = pair.left.label;
        leftChoice.appendChild(leftImg);

        const leftLabel = document.createElement("div");
        leftLabel.className = "choice-label";
        leftLabel.textContent = pair.left.label;
        leftChoice.appendChild(leftLabel);

        const rightChoice = document.createElement("div");
        rightChoice.className = "choice";
        rightChoice.dataset.side = "right";

        const rightImg = document.createElement("img");
        rightImg.src = pair.right.imageUrl;
        rightImg.className = "snack-image";
        rightImg.alt = pair.right.label;
        rightChoice.appendChild(rightImg);

        const rightLabel = document.createElement("div");
        rightLabel.className = "choice-label";
        rightLabel.textContent = pair.right.label;
        rightChoice.appendChild(rightLabel);

        const onSelect = (selectedEl, otherEl) => {
          selectedEl.classList.add("selected");
          otherEl.classList.remove("selected");
        };

        leftChoice.addEventListener("click", () => onSelect(leftChoice, rightChoice));
        rightChoice.addEventListener("click", () => onSelect(rightChoice, leftChoice));

        choiceRow.appendChild(leftChoice);
        choiceRow.appendChild(rightChoice);

        pairBox.appendChild(choiceRow);
        container.appendChild(pairBox);
      });

      viewerMessageEl.textContent = "※ このサンプルでは投票結果は Supabase には保存せず、「どっち選んだか」をその場だけで楽しむモードです。";
    }

    // ====== 編集用: ギャラリー読み込み→ビルダーに流し込み ============
    async function loadGalleryForEdit(galleryId) {
      builderMessageEl.textContent = "編集元ギャラリーを読み込み中…";

      const { data, error } = await sb
        .from("galleries")
        .select("title, config")
        .eq("id", galleryId)
        .single();

      if (error || !data) {
        console.error(error);
        builderMessageEl.textContent = "編集元のギャラリーが見つかりませんでした。IDやURLを確認してください。";
        return;
      }

      const config = data.config;
      document.getElementById("galleryTitle").value = config.title || data.title || "";

      pairsContainer.innerHTML = "";
      pairCount = 0;

      (config.pairs || []).forEach(pair => {
        addPair(pair);
      });

      builderMessageEl.textContent = "編集元を読み込みました。この内容をベースに新しいギャラリーとして保存できます。";
    }

    // ====== 画面切り替え ===========================================
    (function init() {
      if (editGalleryIdFromUrl) {
        // 編集モード
        builderHeadingEl.textContent = "① ギャラリー編集（複製して新URLを作成）";
        builderEl.classList.remove("hidden");
        viewerEl.classList.add("hidden");
        loadGalleryForEdit(editGalleryIdFromUrl);
      } else if (galleryIdFromUrl) {
        // viewer モード
        builderEl.classList.add("hidden");
        viewerEl.classList.remove("hidden");
        loadGalleryForView(galleryIdFromUrl);
      } else {
        // 新規作成モード
        builderHeadingEl.textContent = "① ギャラリー作成（新規）";
        builderEl.classList.remove("hidden");
        viewerEl.classList.add("hidden");
      }
    })();
  </script>
</body>
</html>
